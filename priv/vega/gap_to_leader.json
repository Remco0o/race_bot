{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "description": "A scatterplot showing horsepower and miles per gallons for various cars.",
  "params": [{"name": "current_lap", "value": 10}],
  "datasets": {
    "gaps_data": [
      {"lap": 1, "n": "VER", "gap": 1, "c": "#58aaac"},
      {"lap": 2, "n": "VER", "gap": 1.2, "c": "#58aaac"},
      {"lap": 3, "n": "VER", "gap": 0, "c": "#58aaac"},
      {"lap": 1, "n": "PER", "gap": 1.5, "c": "#58aaac"},
      {"lap": 2, "n": "PER", "gap": 1, "c": "#58aaac"},
      {"lap": 3, "n": "PER", "gap": 1.3, "c": "#58aaac"},
      {"lap": 1, "n": "HAM", "gap": 0, "c": "#BBAAAA"},
      {"lap": 2, "n": "HAM", "gap": 0, "c": "#BBAAAA"},
      {"lap": 3, "n": "HAM", "gap": 1.4, "c": "#BBAAAA"},
      {"lap": 10, "n": "HAM", "gap": 1.1, "c": "#BBAAAA"}
    ],
    "track_data": [
      {
        "ts_from": null,
        "ts_to": null,
        "lap_from": 2.3,
        "lap_to": 4,
        "status": "VSC",
        "type": "interval"
      },
      {
        "ts_from": null,
        "ts_to": null,
        "lap_from": 6.3,
        "lap_to": null,
        "status": "SC",
        "type": "interval"
      },
      {
        "ts_from": null,
        "ts_to": null,
        "lap_from": 4,
        "lap_to": 4,
        "status": "Red Flag",
        "type": "instant"
      }
    ]
  },
  "data": {"name": "gaps_data"},
  "encoding": {
    "detail": {"field": "n", "type": "nominal"},
    "color": {
      "field": "c",
      "type": "nominal",
      "legend": null,
      "scale": null,
      "sort": null
    }
  },
  "layer": [
    {
      "data": {"name": "track_data"},
      "transform": [
        {"calculate": "datum.lap_to || current_lap", "as": "lap_to"},
        {"calculate": "(datum.lap_from + datum.lap_to) / 2", "as": "lap_center"}
      ],
      "layer": [
        {
          "comment": "Highlight SC and VSC",
          "mark": {"type": "rect", "opacity": 0.3},
          "encoding": {
            "x": {"field": "lap_from", "type": "quantitative"},
            "x2": {"field": "lap_to"},
            "color": {"value": "#fcfc00"}
          },
          "transform": [{"filter": "datum.type == 'interval'"}]
        },
        {
          "comment": "Label red flags",
          "mark": {
            "type": "text",
            "align": "center",
            "baseline": "bottom",
            "dy": {"expr": "-(height/2) - 5"}
          },
          "encoding": {
            "text": {"field": "status"},
            "color": {"value": "black"},
            "x": {"field": "lap_center", "type": "quantitative"}
          },
          "transform": [{"filter": "datum.type == 'instant'"}]
        },
        {
          "comment": "Vertical line for red flags",
          "mark": {"type": "rule", "strokeWidth": 2},
          "encoding": {
            "text": {"field": "status"},
            "color": {"value": "#ff1200"},
            "x": {"field": "lap_from", "type": "quantitative"}
          },
          "transform": [{"filter": "datum.type == 'instant'"}]
        }
      ]
    },
    {
      "comment": "Gap to leader line",
      "mark": {"type": "line"},
      "encoding": {
        "x": {
          "field": "lap",
          "type": "quantitative",
          "title": "Lap",
          "axis": {"format": ".0f"}
        },
        "y": {
          "field": "gap",
          "type": "quantitative",
          "title": null,
          "scale": {"reverse": true},
          "axis": {"labelExpr": "format(datum.value, '.1f') + ' s'"}
        }
      }
    },
    {
      "comment": "Label lines",
      "encoding": {
        "x": {"aggregate": "max", "field": "lap", "type": "quantitative"},
        "y": {
          "aggregate": {"argmax": "lap"},
          "field": "gap",
          "type": "quantitative"
        }
      },
      "layer": [
        {"mark": {"type": "circle"}},
        {
          "mark": {"type": "text", "align": "left", "dx": 6},
          "encoding": {"text": {"field": "n"}, "color": {"value": "black"}}
        }
      ]
    }
  ],
  "config": {
    "background": "#FFFFFF00",
    "font": "Roboto",
    "title": {"fontSize": 16, "fontWeight": 500, "font": "Exo 2"},
    "axis": {
      "labelFontSize": 12,
      "titleFontSize": 14,
      "titleFont": "Exo 2",
      "titleFontWeight": 500
    }
  },
  "title": "REPLACE ME",
  "width": "container",
  "height": "container"
}